import * as fs from 'fs';
import * as path from 'path';
import { promises as fsPromises } from 'fs';
import { AnalysisReport, SessionReport } from '../models/report.js';
import { AnalysisResult } from '../core/session-analyzer.js';
import { VERSION } from '@claude-report-analyzer/shared/dist/index.js';

export class ReportGenerator {
  private outputDir: string;

  constructor(outputDir: string) {
    this.outputDir = outputDir;
  }

  async generateReport(
    analysisResults: Map<string, AnalysisResult>,
    sourcePath: string,
    filesAnalyzed: number
  ): Promise<string> {
    // ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    await fsPromises.mkdir(this.outputDir, { recursive: true });

    // ì„¸ì…˜ë³„ ë¦¬í¬íŠ¸ ìƒì„±
    const sessions: SessionReport[] = [];
    let totalMessages = 0;
    let totalCodeBlocks = 0;
    let earliestDate: string | null = null;
    let latestDate: string | null = null;
    const allTopics = new Map<string, number>();

    for (const [fileId, analysis] of analysisResults) {
      const sessionReport: SessionReport = {
        id: fileId,
        sessionCount: analysis.sessionCount,
        totalMessages: analysis.totalMessages,
        userMessages: analysis.userMessages,
        assistantMessages: analysis.assistantMessages,
        codeBlocks: analysis.codeBlocks,
        topics: analysis.topics,
        dateRange: {
          start: analysis.timestamps.first,
          end: analysis.timestamps.last
        }
      };

      sessions.push(sessionReport);
      totalMessages += analysis.totalMessages;
      totalCodeBlocks += analysis.codeBlocks;

      // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
      if (analysis.timestamps.first) {
        if (!earliestDate || analysis.timestamps.first < earliestDate) {
          earliestDate = analysis.timestamps.first;
        }
      }
      if (analysis.timestamps.last) {
        if (!latestDate || analysis.timestamps.last > latestDate) {
          latestDate = analysis.timestamps.last;
        }
      }

      // í† í”½ ì§‘ê³„
      for (const topic of analysis.topics) {
        allTopics.set(topic, (allTopics.get(topic) || 0) + 1);
      }
    }

    // ìƒìœ„ í† í”½ ì¶”ì¶œ
    const topTopics = Array.from(allTopics.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)
      .map(([topic]) => topic);

    // ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
    const report: AnalysisReport = {
      version: '1.0',
      analyzedAt: new Date().toISOString(),
      sourcePath,
      filesAnalyzed,
      sessions,
      summary: {
        totalSessions: sessions.length,
        totalMessages,
        totalCodeBlocks,
        dateRange: {
          start: earliestDate,
          end: latestDate
        },
        topTopics
      },
      metadata: {
        analyzerVersion: VERSION,
        platform: process.platform,
        nodeVersion: process.version
      }
    };

    // JSON íŒŒì¼ë¡œ ì €ì¥
    const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
    const reportPath = path.join(this.outputDir, `analysis-report-${timestamp}.json`);
    await fsPromises.writeFile(reportPath, JSON.stringify(report, null, 2));

    return reportPath;
  }

  async generateMarkdownSummary(reportPath: string): Promise<string> {
    const reportContent = await fsPromises.readFile(reportPath, 'utf-8');
    const report: AnalysisReport = JSON.parse(reportContent);

    const markdown = `# Claude Report Analyzer - ë¶„ì„ ê²°ê³¼

## ğŸ“Š ìš”ì•½
- **ë¶„ì„ ì¼ì‹œ**: ${new Date(report.analyzedAt).toLocaleString('ko-KR')}
- **ë¶„ì„ ëŒ€ìƒ**: ${report.sourcePath}
- **ë¶„ì„ëœ íŒŒì¼ ìˆ˜**: ${report.filesAnalyzed}ê°œ

## ğŸ“ˆ í†µê³„
- **ì´ ì„¸ì…˜ ìˆ˜**: ${report.summary.totalSessions}ê°œ
- **ì´ ë©”ì‹œì§€ ìˆ˜**: ${report.summary.totalMessages}ê°œ
- **ì½”ë“œ ë¸”ë¡ ìˆ˜**: ${report.summary.totalCodeBlocks}ê°œ

## ğŸ“… ë‚ ì§œ ë²”ìœ„
- **ì‹œì‘**: ${report.summary.dateRange.start ? new Date(report.summary.dateRange.start).toLocaleString('ko-KR') : 'N/A'}
- **ì¢…ë£Œ**: ${report.summary.dateRange.end ? new Date(report.summary.dateRange.end).toLocaleString('ko-KR') : 'N/A'}

## ğŸ·ï¸ ì£¼ìš” í† í”½
${report.summary.topTopics.map((topic, index) => `${index + 1}. ${topic}`).join('\\n')}

## ğŸ“ ì„¸ì…˜ë³„ ìƒì„¸
${report.sessions.map(session => `
### ${session.id}
- ë©”ì‹œì§€ ìˆ˜: ${session.totalMessages}ê°œ (ì‚¬ìš©ì: ${session.userMessages}, ì–´ì‹œìŠ¤í„´íŠ¸: ${session.assistantMessages})
- ì½”ë“œ ë¸”ë¡: ${session.codeBlocks}ê°œ
- ì£¼ìš” í‚¤ì›Œë“œ: ${session.topics.slice(0, 5).join(', ')}
`).join('\\n')}

---
*Generated by Claude Report Analyzer v${report.metadata.analyzerVersion}*
`;

    const markdownPath = reportPath.replace('.json', '.md');
    await fsPromises.writeFile(markdownPath, markdown);

    return markdownPath;
  }
}